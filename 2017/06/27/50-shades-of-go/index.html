<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Sin5th, Wuxin" />





  <link rel="alternate" href="/atom.xml" title="Sin5's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0" />






<meta name="description" content="原文出自 这里  Go is a simple and fun language, but, like any other language, it has a few gotchas… Many of those gotchas are not entirely Go’s fault. Some of these mistakes are natural traps if you are co">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="Go 语言的 50 个陷阱">
<meta property="og:url" content="http://blog.sin5th.com/2017/06/27/50-shades-of-go/index.html">
<meta property="og:site_name" content="Sin5's Blog">
<meta property="og:description" content="原文出自 这里  Go is a simple and fun language, but, like any other language, it has a few gotchas… Many of those gotchas are not entirely Go’s fault. Some of these mistakes are natural traps if you are co">
<meta property="og:updated_time" content="2017-06-29T14:13:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Go 语言的 50 个陷阱">
<meta name="twitter:description" content="原文出自 这里  Go is a simple and fun language, but, like any other language, it has a few gotchas… Many of those gotchas are not entirely Go’s fault. Some of these mistakes are natural traps if you are co">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: false,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.sin5th.com/2017/06/27/50-shades-of-go/"/>





  <title> Go 语言的 50 个陷阱 | Sin5's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sin5's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.sin5th.com/2017/06/27/50-shades-of-go/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="武鑫">
      <meta itemprop="description" content="人行中正，剑走偏锋；<br/>目游长远，足履飞星。">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/7314785">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sin5's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                Go 语言的 50 个陷阱
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-27T23:19:42+08:00">
                2017-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/翻译/" itemprop="url" rel="index">
                    <span itemprop="name">翻译</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/27/50-shades-of-go/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/06/27/50-shades-of-go/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                <span title="字数统计">
                  12,053
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                <span title="阅读时长">
                  73
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>原文出自 <a href="http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/index.html" target="_blank" rel="external">这里</a></p>
</blockquote>
<p>Go is a simple and fun language, but, like any other language, it has a few gotchas… Many of those gotchas are not entirely Go’s fault. Some of these mistakes are natural traps if you are coming from another language. Others are due to faulty assumptions and missing details.<br><code hide="">Go 是一门简单而有趣的语言，但是，像其他语言一样，它有一些陷阱。。许多错误不是 Go 的问题，这其中一部分来自于其他语言对你的误导，而另一部分则是错误的猜想和遗漏的细节。</code></p>
<p>A lot of these gotchas may seem obvious if you took the time to learn the language reading the official spec, wiki, mailing list discussions, many great posts and presentations by Rob Pike, and the source code. Not everybody starts the same way though and that’s OK. If you are new to Go the information here will save you hours debugging your code.<br><code hide="">在仔细阅读过官方说明、wiki、往来邮件、Rob Pike 的优秀博客与演示，还有源代码之后，许多陷阱实际上是非常容易识别的。当然不是每个人都这样学习，没关系。如果你刚刚接触 Go，那这篇文章的内容能让你避免许多浪费时间的调试。</code></p>
<p>This post covers Go 1.5 and below.<br><code hide="">本文对 Go 1.5 及以下有效。</code></p>
<h1 id="total-beginner"><a href="#Total-Beginner" class="headerlink" title="Total Beginner"></a>Total Beginner</h1><p>Total Beginner<br><code hide="">真正的初学者</code></p>
<h2 id="opening-brace-cant-be-placed-on-a-separate-line"><a href="#Opening-Brace-Can’t-Be-Placed-on-a-Separate-Line" class="headerlink" title="Opening Brace Can’t Be Placed on a Separate Line"></a>Opening Brace Can’t Be Placed on a Separate Line</h2><p>Opening Brace Can’t Be Placed on a Separate Line<br><code hide="">左括号不能新启一行</code></p>
<p>In most other languages that use braces you get to choose where you place them. Go is different. You can thank automatic semicolon injection (without lookahead) for this behavior. Yes, Go does have semicolons :-)<br><code hide="">在大多数语言里花括号放哪都行，但 Go 不是。</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123; <span class="comment">//error, can't have the opening brace on a separate line</span></div><div class="line">    fmt.Println(<span class="string">"hello there!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox826898458/main.go:6: syntax error: unexpected semicolon or newline before &#123;</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"works!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="unused-variables"><a href="#Unused-Variables" class="headerlink" title="Unused Variables"></a>Unused Variables</h2><p>Unused Variables<br><code hide="">未使用的变量 </code></p>
<p>If you have an unused variable your code will fail to compile. There’s an exception though. You must use variables you declare inside functions, but it’s OK if you have unused global variables. It’s also OK to have unused function arguments.<br><code hide="">代码里有未使用的变量会编译错误，不过也有例外。在函数里的变量必须使用，不过全局变量和函数参数可以不使用。</code></p>
<p>If you assign a new value to the unused variable your code will still fail to compile. You need to use the variable value somehow to make the compiler happy.<br><code hide="">赋值给未使用的变量同样报错，一定是正常使用，不然编译器不会过。</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">var</span> gvar <span class="keyword">int</span> <span class="comment">//not an error</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> one <span class="keyword">int</span>   <span class="comment">//error, unused variable</span></div><div class="line">    two := <span class="number">2</span>      <span class="comment">//error, unused variable</span></div><div class="line">    <span class="keyword">var</span> three <span class="keyword">int</span> <span class="comment">//error, even though it's assigned 3 on the next line</span></div><div class="line">    three = <span class="number">3</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(unused <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">        fmt.Println(<span class="string">"Unused arg. No compile error"</span>)</div><div class="line">    &#125;(<span class="string">"what?"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Errors:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox473116179/main.go:6: one declared and not used /tmp/sandbox473116179/main.go:7: two declared and not used /tmp/sandbox473116179/main.go:8: three declared and not used</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> one <span class="keyword">int</span></div><div class="line">    _ = one</div><div class="line"></div><div class="line">    two := <span class="number">2</span></div><div class="line">    fmt.Println(two)</div><div class="line"></div><div class="line">    <span class="keyword">var</span> three <span class="keyword">int</span></div><div class="line">    three = <span class="number">3</span></div><div class="line">    one = three</div><div class="line"></div><div class="line">    <span class="keyword">var</span> four <span class="keyword">int</span></div><div class="line">    four = four</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Another option is to comment out or remove the unused variables :-)<br><code hide="">另一个方法是注释、或者删除不用的变量 </code></p>
<h2 id="unused-imports"><a href="#Unused-Imports" class="headerlink" title="Unused Imports"></a>Unused Imports</h2><p>Unused Imports<br><code hide="">未使用的包引用</code></p>
<p>Your code will fail to compile if you import a package without using any of its exported functions, interfaces, structures, or variables.<br><code hide="">要是导入了包，但没有用任何其中的方法、类型、变量，那一定会报错。 </code></p>
<p>If you really need the imported package you can use the blank identifier, _, as its package name to avoid this compilation failure. The blank identifier is used to import packages for their side effects.<br><code hide="">如果非要导入包，那么可以用空白标识符作为它的包名，这样就能避免编译失败。空白表示符用来导入包来发挥他们的副作用。</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Errors:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox627475386/main.go:4: imported and not used: &quot;fmt&quot; /tmp/sandbox627475386/main.go:5: imported and not used: &quot;log&quot; /tmp/sandbox627475386/main.go:6: imported and not used: &quot;time&quot;</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    _ <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> _ = log.Println</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    _ = time.Now</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Another option is to remove or comment out the unused imports :-) The  goimports tool can help you with that.<br><code hide="">删除或注释不用的包引用也是可以的</code></p>
<h2 id="short-variable-declarations-can-be-used-only-inside-functions"><a href="#Short-Variable-Declarations-Can-Be-Used-Only-Inside-Functions" class="headerlink" title="Short Variable Declarations Can Be Used Only Inside Functions"></a>Short Variable Declarations Can Be Used Only Inside Functions</h2><p>Short Variable Declarations Can Be Used Only Inside Functions<br><code hide="">短声明只能在函数中使用</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line">myvar := <span class="number">1</span> <span class="comment">//error</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox265716165/main.go:3: non-declaration statement outside function body</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">var</span> myvar = <span class="number">1</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="redeclaring-variables-using-short-variable-declarations"><a href="#Redeclaring-Variables-Using-Short-Variable-Declarations" class="headerlink" title="Redeclaring Variables Using Short Variable Declarations"></a>Redeclaring Variables Using Short Variable Declarations</h2><p>Redeclaring Variables Using Short Variable Declarations<br><code hide="">使用短声明重复对变量赋值</code></p>
<p>You can’t redeclare a variable in a standalone statement, but it is allowed in multi-variable declarations where at least one new variable is also declared.<br><code hide="">不能重复声明变量。但在多变量声明语句中，有一个变量为首次声明也是可以的。</code></p>
<p>The redeclared variable has to be in the same block or you’ll end up with a shadowed variable.<br><code hide="">被重复生命的变量必须在同一个块中，否则就得以一个隐式变量结束。</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    one := <span class="number">0</span></div><div class="line">    one := <span class="number">1</span> <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox706333626/main.go:5: no new variables on left side of :=</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    one := <span class="number">0</span></div><div class="line">    one, two := <span class="number">1</span>,<span class="number">2</span></div><div class="line"></div><div class="line">    one,two = two,one</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="cant-use-short-variable-declarations-to-set-field-values"><a href="#Can’t-Use-Short-Variable-Declarations-to-Set-Field-Values" class="headerlink" title="Can’t Use Short Variable Declarations to Set Field Values"></a>Can’t Use Short Variable Declarations to Set Field Values</h2><p>Can’t Use Short Variable Declarations to Set Field Values<br><code hide="">不能使用短声明来设置字段值</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> info <span class="keyword">struct</span> &#123;</div><div class="line">  result <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>,error)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">13</span>,<span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data info</div><div class="line"></div><div class="line">  data.result, err := work() <span class="comment">//error</span></div><div class="line">  fmt.Printf(<span class="string">"info: %+v\n"</span>,data)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">prog.go:18: non-name data.result on left side of :=</div><div class="line"></div><div class="line">Even though there&apos;s a ticket to address this gotcha it&apos;s unlikely to change because Rob Pike likes it &quot;as is&quot; :-)</div><div class="line"></div><div class="line">Use temporary variables or predeclare all your variables and use the standard assignment operator.</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> info <span class="keyword">struct</span> &#123;</div><div class="line">  result <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>,error)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">13</span>,<span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data info</div><div class="line"></div><div class="line">  <span class="keyword">var</span> err error</div><div class="line">  data.result, err = work() <span class="comment">//ok</span></div><div class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  fmt.Printf(<span class="string">"info: %+v\n"</span>,data) <span class="comment">//prints: info: &#123;result:13&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>##Accidental Variable Shadowing<br>Accidental Variable Shadowing<br><code hide="">意外的变量覆盖</code></p>
<p>The short variable declaration syntax is so convenient (especially for those coming from a dynamic language) that it’s easy to treat it like a regular assignment operation. If you make this mistake in a new code block there will be no compiler error, but your app will not do what you expect.<br><code hide="">短赋值语法很方便（特别是对那些来自动态语言的人来说），以至于很容易把它当成一个常规的赋值操作符。在新的代码块中这么做可以正常编译，但运行效果非你所愿。</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="number">1</span></div><div class="line">    fmt.Println(x)     <span class="comment">//prints 1</span></div><div class="line">    &#123;</div><div class="line">        fmt.Println(x) <span class="comment">//prints 1</span></div><div class="line">        x := <span class="number">2</span></div><div class="line">        fmt.Println(x) <span class="comment">//prints 2</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(x)     <span class="comment">//prints 1 (bad if you need 2)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This is a very common trap even for experienced Go developers. It’s easy to make and it could be hard to spot.<br><code hide="">Go 资深开发者也容易犯这个错。而且不仅容易犯，还难以排查。</code><br>You can use the vet command to find some of these problems. By default,  vet will not perform any shadowed variable checks. Make sure to use the  -shadow flag: go tool vet -shadow your_file.go<br><code hide="">可以使用 vet 指令来找这类问题。vet 默认不会做变量覆盖的检查，所以要用 -shadow: go tool vet -shadow your_file.go</code><br>Note that the vet command will not report all shadowed variables. Use  go-nyet for more aggressive shadowed variable detection.<br><code hide="">注意 vet 指令不会报出所有的变量覆盖，go-nyet 可以做更好的变量覆盖探测。</code> </p>
<h2 id="cant-use-nil-to-initialize-a-variable-without-an-explicit-type"><a href="#Can’t-Use-“nil”-to-Initialize-a-Variable-Without-an-Explicit-Type" class="headerlink" title="Can’t Use “nil” to Initialize a Variable Without an Explicit Type"></a>Can’t Use “nil” to Initialize a Variable Without an Explicit Type</h2><p>Can’t Use “nil” to Initialize a Variable Without an Explicit Type<br><code hide="">不要用 “nil” 初始化非显式声明的变量。</code></p>
<p>The “nil” identifier can be used as the “zero value” for interfaces, functions, pointers, maps, slices, and channels. If you don’t specify the variable type the compiler will fail to compile your code because it can’t guess the type.<br><code hide="">“nil” 能作为接口、函数、指针、哈希、分片、管道的”空值”表示。如果不指定变量类型，便一起会因为猜不出类型而报错。</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> x = <span class="literal">nil</span> <span class="comment">//error</span></div><div class="line"></div><div class="line">    _ = x</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox188239583/main.go:4: use of untyped nil</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> x <span class="keyword">interface</span>&#123;&#125; = <span class="literal">nil</span></div><div class="line"></div><div class="line">    _ = x</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>##Using “nil” Slices and Maps<br>Using “nil” Slices and Maps<br><code hide="">使用 “nil” 分片和哈希</code></p>
<p>It’s OK to add items to a “nil” slice, but doing the same with a map will produce a runtime panic.<br><code hide="">可以往 “nil” 分片中加入元素，但往对 map 这么干就会报错。</code></p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> s []<span class="keyword">int</span></div><div class="line">    s = <span class="built_in">append</span>(s,<span class="number">1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></div><div class="line">    m[<span class="string">"one"</span>] = <span class="number">1</span> <span class="comment">//error</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>##Map Capacity<br>Map Capacity<br><code hide="">map 的容量</code></p>
<p>You can specify the map capacity when it’s created, but you can’t use the cap() function on maps.</p>
<p>#cb可以在创建时指定 map 的容量，但不能对它用 cap() 函数。</p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>,<span class="number">99</span>)</div><div class="line">    <span class="built_in">cap</span>(m) <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox326543983/main.go:5: invalid argument m (type map[string]int) for cap</div></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="strings-cant-be-nil"><a href="#Strings-Can’t-Be-“nil”" class="headerlink" title="Strings Can’t Be “nil”"></a>Strings Can’t Be “nil”</h2><p>Strings Can’t Be “nil”<br><code hide="">字符串不能为空</code></p>
<p>This is a gotcha for developers who are used to assigning “nil” identifiers to string variables.<br><code hide="">对那些习惯将字符串设置为”nil”的开发者，很容出错</code></p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> x <span class="keyword">string</span> = <span class="literal">nil</span> <span class="comment">//error</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> x == <span class="literal">nil</span> &#123; <span class="comment">//error</span></div><div class="line">        x = <span class="string">"default"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Errors:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/tmp/sandbox630560459/main.go:4: cannot use nil as type string in assignment /tmp/sandbox630560459/main.go:6: invalid operation: x == nil (mismatched types string and nil)</div></pre></td></tr></table></figure></p>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> x <span class="keyword">string</span> <span class="comment">//defaults to "" (zero value)</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> x == <span class="string">""</span> &#123;</div><div class="line">        x = <span class="string">"default"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>##Array Function Arguments<br>Array Function Arguments<br><code hide="">数组作为函数参宿</code></p>
<p>If you are a C or C++ developer arrays for you are pointers. When you pass arrays to functions the functions reference the same memory location, so they can update the original data. Arrays in Go are values, so when you pass arrays to functions the functions get a copy of the original array data. This can be a problem if you are trying to update the array data.<br><code hide="">对 c 和 c++ 开发者来说，数组是指针。当传递数组到函数中时，函数使用同一块内存区域，所以可以更新原始数据。在 Go 中，数组是值，所以传递给函数的是一份拷贝。这在执行更新操作时候会出问题。</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(arr [3]<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">        arr[<span class="number">0</span>] = <span class="number">7</span></div><div class="line">        fmt.Println(arr) <span class="comment">//prints [7 2 3]</span></div><div class="line">    &#125;(x)</div><div class="line"></div><div class="line">    fmt.Println(x) <span class="comment">//prints [1 2 3] (not ok if you need [7 2 3])</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>If you need to update the original array data use array pointer types.<br><code hide="">更新数组要使用指针类型</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(arr *[3]<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">        (*arr)[<span class="number">0</span>] = <span class="number">7</span></div><div class="line">        fmt.Println(arr) <span class="comment">//prints &amp;[7 2 3]</span></div><div class="line">    &#125;(&amp;x)</div><div class="line"></div><div class="line">    fmt.Println(x) <span class="comment">//prints [7 2 3]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Another option is to use slices. Even though your function gets a copy of the slice variable it still references the original data.</p>
<p>#cb另一个方法是使用切片。尽管函数拿到了一个分片的复制，但它仍然指向原始数据。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(arr []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">        arr[<span class="number">0</span>] = <span class="number">7</span></div><div class="line">        fmt.Println(arr) <span class="comment">//prints [7 2 3]</span></div><div class="line">    &#125;(x)</div><div class="line"></div><div class="line">    fmt.Println(x) <span class="comment">//prints [7 2 3]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>##Unexpected Values in Slice and Array “range” Clauses<br>Unexpected Values in Slice and Array “range” Clauses<br><code hide="">对分片和数组的 range 中出现始料未及的值</code></p>
<p>This can happen if you are used to the “for-in” or “foreach” statements in other languages. The “range” clause in Go is different. It generates two values: the first value is the item index while the second value is the item data.</p>
<p>Bad:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := []<span class="keyword">string</span>&#123;<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> x &#123;</div><div class="line">        fmt.Println(v) <span class="comment">//prints 0, 1, 2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := []<span class="keyword">string</span>&#123;<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> x &#123;</div><div class="line">        fmt.Println(v) <span class="comment">//prints a, b, c</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Slices and Arrays Are One-Dimensional</p>
<p>It may seem like Go supports multi-dimensional arrays and slices, but it doesn’t. Creating arrays of arrays or slices of slices is possible though. For numerical computation apps that rely on dynamic multi-dimensional arrays it’s far from ideal in terms of performance and complexity.</p>
<p>You can build dynamic multi-dimensional arrays using raw one-dimensional arrays, slices of “independent” slices, and slices of “shared data” slices.</p>
<p>If you are using raw one-dimensional arrays you are responsible for indexing, bounds checking, and memory reallocations when the arrays need to grow.</p>
<p>Creating a dynamic multi-dimensional array using slices of “independent” slices is a two step process. First, you have to create the outer slice. Then, you have to allocate each inner slice. The inner slices are independent of each other. You can grow and shrink them without affecting other inner slices.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="number">2</span></div><div class="line">    y := <span class="number">4</span></div><div class="line"></div><div class="line">    table := <span class="built_in">make</span>([][]<span class="keyword">int</span>,x)</div><div class="line">    <span class="keyword">for</span> i:= <span class="keyword">range</span> table &#123;</div><div class="line">        table[i] = <span class="built_in">make</span>([]<span class="keyword">int</span>,y)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Creating a dynamic multi-dimensional array using slices of “shared data” slices is a three step process. First, you have to create the data “container” slice that will hold raw data. Then, you create the outer slice. Finally, you initialize each inner slice by reslicing the raw data slice.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    h, w := <span class="number">2</span>, <span class="number">4</span></div><div class="line"></div><div class="line">    raw := <span class="built_in">make</span>([]<span class="keyword">int</span>,h*w)</div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> raw &#123;</div><div class="line">        raw[i] = i</div><div class="line">    &#125;</div><div class="line">    fmt.Println(raw,&amp;raw[<span class="number">4</span>])</div><div class="line">    <span class="comment">//prints: [0 1 2 3 4 5 6 7] &lt;ptr_addr_x&gt;</span></div><div class="line"></div><div class="line">    table := <span class="built_in">make</span>([][]<span class="keyword">int</span>,h)</div><div class="line">    <span class="keyword">for</span> i:= <span class="keyword">range</span> table &#123;</div><div class="line">        table[i] = raw[i*w:i*w + w]</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(table,&amp;table[<span class="number">1</span>][<span class="number">0</span>])</div><div class="line">    <span class="comment">//prints: [[0 1 2 3] [4 5 6 7]] &lt;ptr_addr_x&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>There’s a spec/proposal for multi-dimensional arrays and slices, but it looks like it’s a low priority feature at this point in time.</p>
<p>Accessing Non-Existing Map Keys</p>
<p>This is a gotcha for developers who expect to get “nil” identifiers (like it’s done in other languages). The returned value will be “nil” if the “zero value” for the corresponding data type is “nil”, but it’ll be different for other data types. Checking for the appropriate “zero value” can be used to determine if the map record exists, but it’s not always reliable (e.g., what do you do if you have a map of booleans where the “zero value” is false). The most reliable way to know if a given map record exists is to check the second value returned by the map access operation.</p>
<p>Bad:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"one"</span>:<span class="string">"a"</span>,<span class="string">"two"</span>:<span class="string">""</span>,<span class="string">"three"</span>:<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> v := x[<span class="string">"two"</span>]; v == <span class="string">""</span> &#123; <span class="comment">//incorrect</span></div><div class="line">        fmt.Println(<span class="string">"no entry"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"one"</span>:<span class="string">"a"</span>,<span class="string">"two"</span>:<span class="string">""</span>,<span class="string">"three"</span>:<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> _,ok := x[<span class="string">"two"</span>]; !ok &#123;</div><div class="line">        fmt.Println(<span class="string">"no entry"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Strings Are Immutable</p>
<p>Trying to update an individual character in a string variable using the index operator will result in a failure. Strings are read-only byte slices (with a few extra properties). If you do need to update a string then use a byte slice instead converting it to a string type when necessary.</p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="string">"text"</span></div><div class="line">    x[<span class="number">0</span>] = <span class="string">'T'</span></div><div class="line"></div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:</p>
</blockquote>
<p>/tmp/sandbox305565531/main.go:7: cannot assign to x[0]</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="string">"text"</span></div><div class="line">    xbytes := []<span class="keyword">byte</span>(x)</div><div class="line">    xbytes[<span class="number">0</span>] = <span class="string">'T'</span></div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(xbytes)) <span class="comment">//prints Text</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Note that this isn’t really the right way to update characters in a text string because a given character could be stored in multiple bytes. If you do need to make updates to a text string convert it to a rune sclice first. Even with rune slices a single character might span multiple runes, which can happen if you have characters with grave accent, for example. This complicated and ambiguous nature of “characters” is the reason why Go strings are represented as byte sequences.</p>
<p>Conversions Between Strings and Byte Slices</p>
<p>When you convert a string to a byte slice (and vice versa) you get a complete copy of the orginal data. It’s not like a cast operation in other languages and it’s not like reslicing where the new slice variable points to the same underlying array used by the original byte slice.</p>
<p>Go does have a couple of optimizations for []byte to string and string to  []byte conversions to avoid extra allocations (with more optimizations on the todo list).</p>
<p>The first optimization avoids extra allocations when []byte keys are used to lookup entries in map[string] collections: m[string(key)].</p>
<p>The second optimization avoids extra allocations in for range clauses where strings are converted to []byte: for i,v := range []byte(str) {…}.</p>
<p>Strings and Index Operator</p>
<p>The index operator on a string returns a byte value, not a character (like it’s done in other languages).</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := <span class="string">"text"</span></div><div class="line">    fmt.Println(x[<span class="number">0</span>]) <span class="comment">//print 116</span></div><div class="line">    fmt.Printf(<span class="string">"%T"</span>,x[<span class="number">0</span>]) <span class="comment">//prints uint8</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you need to access specific string “characters” (unicode code points/runes) use the for range clause. The official “unicode/utf8” package and the experimental utf8string package (golang.org/x/exp/utf8string) are also useful. The utf8string package includes a convenient At() method. Converting the string to a slice of runes is an option too.</p>
<p>Strings Are Not Always UTF8 Text</p>
<p>String values are not required to be UTF8 text. They can contain arbitrary bytes. The only time strings are UTF8 is when string literals are used. Even then they can include other data using escape sequences.</p>
<p>To know if you have a UTF8 text string use the ValidString() function from the “unicode/utf8” package.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unicode/utf8"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data1 := <span class="string">"ABC"</span></div><div class="line">    fmt.Println(utf8.ValidString(data1)) <span class="comment">//prints: true</span></div><div class="line"></div><div class="line">    data2 := <span class="string">"A\xfeC"</span></div><div class="line">    fmt.Println(utf8.ValidString(data2)) <span class="comment">//prints: false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>String Length</p>
<p>Let’s say you are a python developer and you have the following piece of code:</p>
<p>data = u’♥’<br>print(len(data)) #prints: 1<br>When you convert it to a similar Go code snippet you might be surprised.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := <span class="string">"♥"</span></div><div class="line">    fmt.Println(<span class="built_in">len</span>(data)) <span class="comment">//prints: 3</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The built-in len() function returns the number of bytes instead of the number of characters like it’s done for unicode strings in Python.</p>
<p>To get the same results in Go use the RuneCountInString() function from the “unicode/utf8” package.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unicode/utf8"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := <span class="string">"♥"</span></div><div class="line">    fmt.Println(utf8.RuneCountInString(data)) <span class="comment">//prints: 1</span></div><div class="line">Technically the RuneCountInString() function doesn<span class="string">'t return the number of characters because a single character may span multiple runes.</span></div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    "fmt"</div><div class="line">    "unicode/utf8"</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    data := "é"</div><div class="line">    fmt.Println(len(data))                    //prints: 3</div><div class="line">    fmt.Println(utf8.RuneCountInString(data)) //prints: 2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Missing Comma In Multi-Line Slice, Array, and Map Literals</p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := []<span class="keyword">int</span>&#123;</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span> <span class="comment">//error</span></div><div class="line">    &#125;</div><div class="line">    _ = x</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Errors:</p>
</blockquote>
<p>/tmp/sandbox367520156/main.go:6: syntax error: need trailing comma before newline in composite literal /tmp/sandbox367520156/main.go:8: non-declaration statement outside function body /tmp/sandbox367520156/main.go:9: syntax error: unexpected }</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    x := []<span class="keyword">int</span>&#123;</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span>,</div><div class="line">    &#125;</div><div class="line">    x = x</div><div class="line"></div><div class="line">    y := []<span class="keyword">int</span>&#123;<span class="number">3</span>,<span class="number">4</span>,&#125; <span class="comment">//no error</span></div><div class="line">    y = y</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>You won’t get a compiler error if you leave the trailing comma when you collapse the declaration to be on a single line.</p>
<p>log.Fatal and log.Panic Do More Than Log</p>
<p>Logging libraries often provide different log levels. Unlike those logging libraries, the log package in Go does more than log if you call its Fatal<em>() and Panic</em>() functions. When your app calls those functions Go will also terminate your app :-)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"log"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    log.Fatalln(<span class="string">"Fatal Level: log entry"</span>) <span class="comment">//app exits here</span></div><div class="line">    log.Println(<span class="string">"Normal Level: log entry"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Built-in Data Structure Operations Are Not Synchronized</p>
<p>Even though Go has a number of features to support concurrency natively, concurrency safe data collections are not one them :-) It’s your responsibility to ensure the data collection updates are atomic. Goroutines and channels are the recommended way to implement those atomic operations, but you can also leverage the “sync” package if it makes sense for your application.</p>
<p>Iteration Values For Strings in “range” Clauses</p>
<p>The index value (the first value returned by the “range” operation) is the index of the first byte for the current “character” (unicode code point/rune) returned in the second value. It’s not the index for the current “character” like it’s done in other languages. Note that an actual character might be represented by multiple runes. Make sure to check out the “norm” package (golang.org/x/text/unicode/norm) if you need to work with characters.</p>
<p>The for range clauses with string variables will try to interpret the data as UTF8 text. For any byte sequences it doesn’t understand it will return 0xfffd runes (aka unicode replacement characters) instead of the actual data. If you have arbitrary (non-UTF8 text) data stored in your string variables, make sure to convert them to byte slices to get all stored data as is.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := <span class="string">"A\xfe\x02\xff\x04"</span></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        fmt.Printf(<span class="string">"%#x "</span>,v)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//prints: 0x41 0xfffd 0x2 0xfffd 0x4 (not ok)</span></div><div class="line"></div><div class="line">    fmt.Println()</div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> []<span class="keyword">byte</span>(data) &#123;</div><div class="line">        fmt.Printf(<span class="string">"%#x "</span>,v)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//prints: 0x41 0xfe 0x2 0xff 0x4 (good)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Iterating Through a Map Using a “for range” Clause</p>
<p>This is a gotcha if you expect the items to be in a certain order (e.g., ordered by the key value). Each map iteration will produce different results. The Go runtime tries to go an extra mile randomizing the iteration order, but it doesn’t always succeed so you may get several identical map iterations. Don’t be surprised to see 5 identical iterations in a row.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"one"</span>:<span class="number">1</span>,<span class="string">"two"</span>:<span class="number">2</span>,<span class="string">"three"</span>:<span class="number">3</span>,<span class="string">"four"</span>:<span class="number">4</span>&#125;</div><div class="line">    <span class="keyword">for</span> k,v := <span class="keyword">range</span> m &#123;</div><div class="line">        fmt.Println(k,v)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And if you use the Go Playground (<a href="https://play.golang.org/" target="_blank" rel="external">https://play.golang.org/</a>) you’ll always get the same results because it doesn’t recompile the code unless you make a change.</p>
<p>Fallthrough Behavior in “switch” Statements</p>
<p>The “case” blocks in “switch” statements break by default. This is different from other languages where the default behavior is to fall through to the next “case” block.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    isSpace := <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">        <span class="keyword">switch</span>(ch) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">' '</span>: <span class="comment">//error</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'\t'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(isSpace(<span class="string">'\t'</span>)) <span class="comment">//prints true (ok)</span></div><div class="line">    fmt.Println(isSpace(<span class="string">' '</span>))  <span class="comment">//prints false (not ok)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can force the “case” blocks to fall through by using the “fallthrough” statement at the end of each “case” block. You can also rewrite your switch statement to use expression lists in the “case” blocks.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    isSpace := <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">        <span class="keyword">switch</span>(ch) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">' '</span>, <span class="string">'\t'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(isSpace(<span class="string">'\t'</span>)) <span class="comment">//prints true (ok)</span></div><div class="line">    fmt.Println(isSpace(<span class="string">' '</span>))  <span class="comment">//prints true (ok)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Increments and Decrements</p>
<p>Many languages have increment and decrement operators. Unlike other languages, Go doesn’t support the prefix version of the operations. You also can’t use these two operators in expressions.</p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    i := <span class="number">0</span></div><div class="line">    ++i <span class="comment">//error</span></div><div class="line">    fmt.Println(data[i++]) <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Errors:</p>
</blockquote>
<p>/tmp/sandbox101231828/main.go:8: syntax error: unexpected ++ /tmp/sandbox101231828/main.go:9: syntax error: unexpected ++, expecting :</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    i := <span class="number">0</span></div><div class="line">    i++</div><div class="line">    fmt.Println(data[i])</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Bitwise NOT Operator</p>
<p>Many languages use ~ as the unary NOT operator (aka bitwise complement), but Go reuses the XOR operator (^) for that.</p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(~<span class="number">2</span>) <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Compile Error:</p>
</blockquote>
<p>/tmp/sandbox965529189/main.go:6: the bitwise complement operator is ^</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> d <span class="keyword">uint8</span> = <span class="number">2</span></div><div class="line">    fmt.Printf(<span class="string">"%08b\n"</span>,^d)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Go still uses ^ as the XOR operator, which may be confusing for some people.</p>
<p>If you want you can represent a unary NOT operation (e.g, NOT 0x02) with a binary XOR operation (e.g., 0x02 XOR 0xff). This could explain why ^ is reused to represent unary NOT operations.</p>
<p>Go also has a special ‘AND NOT’ bitwise operator (&amp;^), which adds to the NOT operator confusion. It looks like a special feature/hack to support  A AND (NOT B) without requiring parentheses.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> a <span class="keyword">uint8</span> = <span class="number">0x82</span></div><div class="line">    <span class="keyword">var</span> b <span class="keyword">uint8</span> = <span class="number">0x02</span></div><div class="line">    fmt.Printf(<span class="string">"%08b [A]\n"</span>,a)</div><div class="line">    fmt.Printf(<span class="string">"%08b [B]\n"</span>,b)</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"%08b (NOT B)\n"</span>,^b)</div><div class="line">    fmt.Printf(<span class="string">"%08b ^ %08b = %08b [B XOR 0xff]\n"</span>,b,<span class="number">0xff</span>,b ^ <span class="number">0xff</span>)</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"%08b ^ %08b = %08b [A XOR B]\n"</span>,a,b,a ^ b)</div><div class="line">    fmt.Printf(<span class="string">"%08b &amp; %08b = %08b [A AND B]\n"</span>,a,b,a &amp; b)</div><div class="line">    fmt.Printf(<span class="string">"%08b &amp;^%08b = %08b [A 'AND NOT' B]\n"</span>,a,b,a &amp;^ b)</div><div class="line">    fmt.Printf(<span class="string">"%08b&amp;(^%08b)= %08b [A AND (NOT B)]\n"</span>,a,b,a &amp; (^b))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Operator Precedence Differences</p>
<p>Aside from the “bit clear” operators (&amp;^) Go has a set of standard operators shared by many other languages. The operator precedence is not always the same though.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"0x2 &amp; 0x2 + 0x4 -&gt; %#x\n"</span>,<span class="number">0x2</span> &amp; <span class="number">0x2</span> + <span class="number">0x4</span>)</div><div class="line">    <span class="comment">//prints: 0x2 &amp; 0x2 + 0x4 -&gt; 0x6</span></div><div class="line">    <span class="comment">//Go:    (0x2 &amp; 0x2) + 0x4</span></div><div class="line">    <span class="comment">//C++:    0x2 &amp; (0x2 + 0x4) -&gt; 0x2</span></div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"0x2 + 0x2 &lt;&lt; 0x1 -&gt; %#x\n"</span>,<span class="number">0x2</span> + <span class="number">0x2</span> &lt;&lt; <span class="number">0x1</span>)</div><div class="line">    <span class="comment">//prints: 0x2 + 0x2 &lt;&lt; 0x1 -&gt; 0x6</span></div><div class="line">    <span class="comment">//Go:     0x2 + (0x2 &lt;&lt; 0x1)</span></div><div class="line">    <span class="comment">//C++:   (0x2 + 0x2) &lt;&lt; 0x1 -&gt; 0x8</span></div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"0xf | 0x2 ^ 0x2 -&gt; %#x\n"</span>,<span class="number">0xf</span> | <span class="number">0x2</span> ^ <span class="number">0x2</span>)</div><div class="line">    <span class="comment">//prints: 0xf | 0x2 ^ 0x2 -&gt; 0xd</span></div><div class="line">    <span class="comment">//Go:    (0xf | 0x2) ^ 0x2</span></div><div class="line">    <span class="comment">//C++:    0xf | (0x2 ^ 0x2) -&gt; 0xf</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Unexported Structure Fields Are Not Encoded</p>
<p>The struct fields starting with lowercase letters will not be (json, xml, gob, etc.) encoded, so when you decode the structure you’ll end up with zero values in those unexported fields.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> MyData <span class="keyword">struct</span> &#123;</div><div class="line">    One <span class="keyword">int</span></div><div class="line">    two <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func main() {<br>    in := MyData{1,”two”}<br>    fmt.Printf(“%#v\n”,in) //prints main.MyData{One:1, two:”two”}</p>
<pre><code>encoded,_ := json.Marshal(in)
fmt.Println(string(encoded)) //prints {&quot;One&quot;:1}

var out MyData
json.Unmarshal(encoded,&amp;out)

fmt.Printf(&quot;%#v\n&quot;,out) //prints main.MyData{One:1, two:&quot;&quot;}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">App Exits With Active Goroutines</div><div class="line"></div><div class="line"></div><div class="line">The app will not wait for all your goroutines to complete. This is a common mistake for beginners in general. Everybody starts somewhere, so there&apos;s no shame in making rookie mistakes :-)</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;time&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    workerCount := 2</div><div class="line"></div><div class="line">    for i := 0; i &lt; workerCount; i++ &#123;</div><div class="line">        go doit(i)</div><div class="line">    &#125;</div><div class="line">    time.Sleep(1 * time.Second)</div><div class="line">    fmt.Println(&quot;all done!&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func doit(workerId int) {<br>    fmt.Printf(“[%v] is running\n”,workerId)<br>    time.Sleep(3 * time.Second)<br>    fmt.Printf(“[%v] is done\n”,workerId)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">You&apos;ll see:</div><div class="line"></div><div class="line">[0] is running</div><div class="line">[1] is running</div><div class="line">all done!</div><div class="line"></div><div class="line">One of the most common solutions is to use a &quot;WaitGroup&quot; variable. It will allow the main goroutine to wait until all worker goroutines are done. If your app has long running workers with message processing loops you&apos;ll also need a way to signal those goroutines that it&apos;s time to exit. You can send a &quot;kill&quot; message to each worker. Another option is to close a channel all workers are receiving from. It&apos;s a simple way to signal all goroutines at once.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;sync&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    var wg sync.WaitGroup</div><div class="line">    done := make(chan struct&#123;&#125;)</div><div class="line">    workerCount := 2</div><div class="line"></div><div class="line">    for i := 0; i &lt; workerCount; i++ &#123;</div><div class="line">        wg.Add(1)</div><div class="line">        go doit(i,done,wg)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    close(done)</div><div class="line">    wg.Wait()</div><div class="line">    fmt.Println(&quot;all done!&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func doit(workerId int,done &lt;-chan struct{},wg sync.WaitGroup) {<br>    fmt.Printf(“[%v] is running\n”,workerId)<br>    defer wg.Done()<br>    &lt;- done<br>    fmt.Printf(“[%v] is done\n”,workerId)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">If you run this app you&apos;ll see:</div><div class="line"></div><div class="line">[0] is running</div><div class="line">[0] is done</div><div class="line">[1] is running</div><div class="line">[1] is done</div><div class="line"></div><div class="line">Looks like the workers are done before the main goroutine exists. Great! However, you&apos;ll also see this:</div><div class="line"></div><div class="line">fatal error: all goroutines are asleep - deadlock!</div><div class="line"></div><div class="line">That&apos;s not so great :-) What&apos;s going on? Why is there a deadlock? The workers exited and they executed wg.Done(). The app should work.</div><div class="line"></div><div class="line">The deadlock happens because each worker gets a copy of the original &quot;WaitGroup&quot; variable. When workers execute wg.Done() it has no effect on the &quot;WaitGroup&quot; variable in the main goroutine.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;sync&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    var wg sync.WaitGroup</div><div class="line">    done := make(chan struct&#123;&#125;)</div><div class="line">    wq := make(chan interface&#123;&#125;)</div><div class="line">    workerCount := 2</div><div class="line"></div><div class="line">    for i := 0; i &lt; workerCount; i++ &#123;</div><div class="line">        wg.Add(1)</div><div class="line">        go doit(i,wq,done,&amp;wg)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    for i := 0; i &lt; workerCount; i++ &#123;</div><div class="line">        wq &lt;- i</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    close(done)</div><div class="line">    wg.Wait()</div><div class="line">    fmt.Println(&quot;all done!&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func doit(workerId int, wq &lt;-chan interface{},done &lt;-chan struct{},wg *sync.WaitGroup) {<br>    fmt.Printf(“[%v] is running\n”,workerId)<br>    defer wg.Done()<br>    for {<br>        select {<br>        case m := &lt;- wq:<br>            fmt.Printf(“[%v] m =&gt; %v\n”,workerId,m)<br>        case &lt;- done:<br>            fmt.Printf(“[%v] is done\n”,workerId)<br>            return<br>        }<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Now it works as expected :-)</div><div class="line"></div><div class="line">Sending to an Unbuffered Channel Returns As Soon As the Target Receiver Is Ready</div><div class="line"></div><div class="line"></div><div class="line">The sender will not be blocked until your message is processed by the receiver. Depending on the machine where you are running the code, the receiver goroutine may or may not have enough time to process the message before the sender continues its execution.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    ch := make(chan string)</div><div class="line"></div><div class="line">    go func() &#123;</div><div class="line">        for m := range ch &#123;</div><div class="line">            fmt.Println(&quot;processed:&quot;,m)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    ch &lt;- &quot;cmd.1&quot;</div><div class="line">    ch &lt;- &quot;cmd.2&quot; //won&apos;t be processed</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Sending to an Closed Channel Causes a Panic</p>
<p>Receiving from a closed channel is safe. The ok return value in a receive statement will be set to false indicating that no data was received. If you are receiving from a buffered channel you’ll get the buffered data first and once it’s empty the ok return value will be false.</p>
<p>Sending data to a closed channel causes a panic. It is a documented behavior, but it’s not very intuitive for new Go developers who might expect the send behavior to be similar to the receive behavior.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">            ch &lt;- (idx + <span class="number">1</span>) * <span class="number">2</span></div><div class="line">        &#125;(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//get the first result</span></div><div class="line">    fmt.Println(&lt;-ch)</div><div class="line">    <span class="built_in">close</span>(ch) <span class="comment">//not ok (you still have other senders)</span></div><div class="line">    <span class="comment">//do other work</span></div><div class="line">    time.Sleep(<span class="number">2</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Depending on your application the fix will be different. It might be a minor code change or it might require a change in your application design. Either way, you’ll need to make sure your application doesn’t try to send data to a closed channel.</p>
<p>The buggy example can be fixed by using a special cancellation channel to signal the remaining workers that their results are no longer neeeded.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> ch &lt;- (idx + <span class="number">1</span>) * <span class="number">2</span>: fmt.Println(idx,<span class="string">"sent result"</span>)</div><div class="line">            <span class="keyword">case</span> &lt;- done: fmt.Println(idx,<span class="string">"exiting"</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//get first result</span></div><div class="line">    fmt.Println(<span class="string">"result:"</span>,&lt;-ch)</div><div class="line">    <span class="built_in">close</span>(done)</div><div class="line">    <span class="comment">//do other work</span></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Using “nil” Channels</p>
<p>Send and receive operations on a nil channel block forver. It’s a well documented behavior, but it can be a surprise for new Go developers.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">            ch &lt;- (idx + <span class="number">1</span>) * <span class="number">2</span></div><div class="line">        &#125;(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//get first result</span></div><div class="line">    fmt.Println(<span class="string">"result:"</span>,&lt;-ch)</div><div class="line">    <span class="comment">//do other work</span></div><div class="line">    time.Sleep(<span class="number">2</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you run the code you’ll see a runtime error like this:  fatal error: all goroutines are asleep - deadlock!</p>
<p>This behavior can be used as a way to dynamically enable and disable case blocks in a select statement.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="keyword">import</span> <span class="string">"time"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    inch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    outch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">var</span> in &lt;- <span class="keyword">chan</span> <span class="keyword">int</span> = inch</div><div class="line">        <span class="keyword">var</span> out <span class="keyword">chan</span> &lt;- <span class="keyword">int</span></div><div class="line">        <span class="keyword">var</span> val <span class="keyword">int</span></div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> out &lt;- val:</div><div class="line">                out = <span class="literal">nil</span></div><div class="line">                in = inch</div><div class="line">            <span class="keyword">case</span> val = &lt;- in:</div><div class="line">                out = outch</div><div class="line">                in = <span class="literal">nil</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> r := <span class="keyword">range</span> outch &#123;</div><div class="line">            fmt.Println(<span class="string">"result:"</span>,r)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">0</span>)</div><div class="line">    inch &lt;- <span class="number">1</span></div><div class="line">    inch &lt;- <span class="number">2</span></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Methods with Value Receivers Can’t Change the Original Value</p>
<p>Method receivers are like regular function arguments. If it’s declared to be a value then your function/method gets a copy of your receiver argument. This means making changes to the receiver will not affect the original value unless your receiver is a map or slice variable and you are updating the items in the collection or the fields you are updating in the receiver are pointers.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;</div><div class="line">    num <span class="keyword">int</span></div><div class="line">    key *<span class="keyword">string</span></div><div class="line">    items <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func (this *data) pmethod() {<br>    this.num = 7<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">func (this data) vmethod() &#123;</div><div class="line">    this.num = 8</div><div class="line">    *this.key = &quot;v.key&quot;</div><div class="line">    this.items[&quot;vmethod&quot;] = true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    key := “key.1”<br>    d := data{1,&amp;key,make(map[string]bool)}</p>
<pre><code>fmt.Printf(&quot;num=%v key=%v items=%v\n&quot;,d.num,*d.key,d.items)
//prints num=1 key=key.1 items=map[]

d.pmethod()
fmt.Printf(&quot;num=%v key=%v items=%v\n&quot;,d.num,*d.key,d.items)
//prints num=7 key=key.1 items=map[]

d.vmethod()
fmt.Printf(&quot;num=%v key=%v items=%v\n&quot;,d.num,*d.key,d.items)
//prints num=7 key=v.key items=map[vmethod:true]
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Closing HTTP Response Body</div><div class="line"></div><div class="line">level: intermediate</div><div class="line">When you make requests using the standard http library you get a http response variable. If you don&apos;t read the response body you still need to close it. Note that you must do it for empty responses too. It&apos;s very easy to forget especially for new Go developers.</div><div class="line"></div><div class="line">Some new Go developers do try to close the response body, but they do it in the wrong place.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;net/http&quot;</div><div class="line">    &quot;io/ioutil&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    resp, err := http.Get(&quot;https://api.ipify.org?format=json&quot;)</div><div class="line">    defer resp.Body.Close()//not ok</div><div class="line">    if err != nil &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        return</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    if err != nil &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        return</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(string(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This code works for successful requests, but if the http request fails the resp variable might be nil, which will cause a runtime panic.</p>
<p>The most common why to close the response body is by using a defer call after the http response error check.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    resp, err := http.Get(<span class="string">"https://api.ipify.org?format=json"</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">defer</span> resp.Body.Close()<span class="comment">//ok, most of the time :-)</span></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Most of the time when your http request fails the resp variable will be nil and the err variable will be non-nil. However, when you get a redirection failure both variables will be non-nil. This means you can still end up with a leak.</p>
<p>You can fix this leak by adding a call to close non-nil response bodies in the http response error handling block. Another option is to use one defer call to close response bodies for all failed and successful requests.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    resp, err := http.Get(<span class="string">"https://api.ipify.org?format=json"</span>)</div><div class="line">    <span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">defer</span> resp.Body.Close()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The orignal implementation for resp.Body.Close() also reads and discards the remaining response body data. This ensured that the http connection could be reused for another request if the keepalive http connection behavior is enabled. The latest http client behavior is different. Now it’s your responsibility to read and discard the remaining response data. If you don’t do it the http connection might be closed instead of being reused. This little gotcha is supposed to be documented in Go 1.5.</p>
<p>If reusing the http connection is important for your application you might need to add something like this at the end of your response processing logic:</p>
<p>_, err = io.Copy(ioutil.Discard, resp.Body)<br>It will be necessary if you don’t read the entire response body right away, which might happen if you are processing json API responses with code like this:</p>
<p>json.NewDecoder(resp.Body).Decode(&amp;data)<br>Closing HTTP Connections</p>
<p>level: intermediate<br>Some HTTP servers keep network connections open for a while (based on the HTTP 1.1 spec and the server “keep-alive” configurations). By default, the standard http library will close the network connections only when the target HTTP server asks for it. This means your app may run out of sockets/file descriptors under certain conditions.</p>
<p>You can ask the http library to close the connection after your request is done by setting the Close field in the request variable to true.</p>
<p>Another option is to add a Connection request header and set it to close. The target HTTP server should respond with a Connection: close header too. When the http library sees this response header it will also close the connection.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    req, err := http.NewRequest(<span class="string">"GET"</span>,<span class="string">"http://golang.org"</span>,<span class="literal">nil</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    req.Close = <span class="literal">true</span></div><div class="line">    <span class="comment">//or do this:</span></div><div class="line">    <span class="comment">//req.Header.Add("Connection", "close")</span></div><div class="line"></div><div class="line">    resp, err := http.DefaultClient.Do(req)</div><div class="line">    <span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">defer</span> resp.Body.Close()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="built_in">len</span>(<span class="keyword">string</span>(body)))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can also disable http connection reuse globally. You’ll need to create a custom http transport configuration for it.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    tr := &amp;http.Transport&#123;DisableKeepAlives: <span class="literal">true</span>&#125;</div><div class="line">    client := &amp;http.Client&#123;Transport: tr&#125;</div><div class="line"></div><div class="line">    resp, err := client.Get(<span class="string">"http://golang.org"</span>)</div><div class="line">    <span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">defer</span> resp.Body.Close()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(resp.StatusCode)</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="built_in">len</span>(<span class="keyword">string</span>(body)))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you send a lot of requests to the same HTTP server it’s ok to keep the network connection open. However, if your app sends one or two requests to many different HTTP servers in a short period of time it’s a good idea to close the network connections right after your app receives the responses. Increasing the open file limit might be a good idea too. The correct solution depends on your application though.</p>
<p>Unmarshalling JSON Numbers into Interface Values</p>
<p>level: intermediate<br>By default, Go treats numeric values in JSON as float64 numbers when you decode/unmarshal JSON data into an interface. This means the following code will fail with a panic:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">if</span> err := json.Unmarshal(data, &amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status = result[<span class="string">"status"</span>].(<span class="keyword">int</span>) <span class="comment">//error</span></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Runtime Panic:</p>
<p>panic: interface conversion: interface is float64, not int</p>
<p>If the JSON value you are trying to decode is an integer you have serveral options.</p>
<p>Option one: use the float value as-is :-)</p>
<p>Option two: convert the float value to the integer type you need.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">if</span> err := json.Unmarshal(data, &amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status = <span class="keyword">uint64</span>(result[<span class="string">"status"</span>].(<span class="keyword">float64</span>)) <span class="comment">//ok</span></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Option three: use a Decoder type to unmarshal JSON and tell it to represent JSON numbers using the Number interface type.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">var</span> decoder = json.NewDecoder(bytes.NewReader(data))</div><div class="line">  decoder.UseNumber()</div><div class="line"></div><div class="line">  <span class="keyword">if</span> err := decoder.Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status,_ = result[<span class="string">"status"</span>].(json.Number).Int64() <span class="comment">//ok</span></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can use the string representation of your Number value to unmarshal it to a different numeric type:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">var</span> decoder = json.NewDecoder(bytes.NewReader(data))</div><div class="line">  decoder.UseNumber()</div><div class="line"></div><div class="line">  <span class="keyword">if</span> err := decoder.Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status <span class="keyword">uint64</span></div><div class="line">  <span class="keyword">if</span> err := json.Unmarshal([]<span class="keyword">byte</span>(result[<span class="string">"status"</span>].(json.Number).String()), &amp;status); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Option four: use a struct type that maps your numeric value to the numeric type you need.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">struct</span> &#123;</div><div class="line">    Status <span class="keyword">uint64</span> <span class="string">`json:"status"`</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> err := json.NewDecoder(bytes.NewReader(data)).Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  fmt.Printf(<span class="string">"result =&gt; %+v"</span>,result)</div><div class="line">  <span class="comment">//prints: result =&gt; &#123;Status:200&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Option five: use a struct that maps your numeric value to the json.RawMessage type if you need to defer the value decoding.</p>
<p>This option is useful if you have to perform conditional JSON field decoding where the field type or structure might change.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  records := [][]<span class="keyword">byte</span>&#123;</div><div class="line">    []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200, "tag":"one"&#125;`</span>),</div><div class="line">    []<span class="keyword">byte</span>(<span class="string">`&#123;"status":"ok", "tag":"two"&#125;`</span>),</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> idx, record := <span class="keyword">range</span> records &#123;</div><div class="line">    <span class="keyword">var</span> result <span class="keyword">struct</span> &#123;</div><div class="line">      StatusCode <span class="keyword">uint64</span></div><div class="line">      StatusName <span class="keyword">string</span></div><div class="line">      Status json.RawMessage <span class="string">`json:"status"`</span></div><div class="line">      Tag <span class="keyword">string</span>             <span class="string">`json:"tag"`</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err := json.NewDecoder(bytes.NewReader(record)).Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">      fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> sstatus <span class="keyword">string</span></div><div class="line">    <span class="keyword">if</span> err := json.Unmarshal(result.Status, &amp;sstatus); err == <span class="literal">nil</span> &#123;</div><div class="line">      result.StatusName = sstatus</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> nstatus <span class="keyword">uint64</span></div><div class="line">    <span class="keyword">if</span> err := json.Unmarshal(result.Status, &amp;nstatus); err == <span class="literal">nil</span> &#123;</div><div class="line">      result.StatusCode = nstatus</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"[%v] result =&gt; %+v\n"</span>,idx,result)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Comparing Structs, Arrays, Slices, and Maps</p>
<p>level: intermediate<br>You can use the equality operator, ==, to compare struct variables if each structure field can be compared with the equality operator.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;</div><div class="line">    num <span class="keyword">int</span></div><div class="line">    fp <span class="keyword">float32</span></div><div class="line">    <span class="built_in">complex</span> <span class="keyword">complex64</span></div><div class="line">    str <span class="keyword">string</span></div><div class="line">    char <span class="keyword">rune</span></div><div class="line">    yes <span class="keyword">bool</span></div><div class="line">    events &lt;-<span class="keyword">chan</span> <span class="keyword">string</span></div><div class="line">    handler <span class="keyword">interface</span>&#123;&#125;</div><div class="line">    ref *<span class="keyword">byte</span></div><div class="line">    raw [<span class="number">10</span>]<span class="keyword">byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func main() {<br>    v1 := data{}<br>    v2 := data{}<br>    fmt.Println(“v1 == v2:”,v1 == v2) //prints: v1 == v2: true<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">If any of the struct fields are not comparable then using the equality operator will result in compile time errors. Note that arrays are comparable only if their data items are comparable.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    num int                //ok</div><div class="line">    checks [10]func() bool //not comparable</div><div class="line">    doit func() bool       //not comparable</div><div class="line">    m map[string] string   //not comparable</div><div class="line">    bytes []byte           //not comparable</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    v1 := data{}<br>    v2 := data{}<br>    fmt.Println(“v1 == v2:”,v1 == v2)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Go does provide a number of helper functions to compare variables that can&apos;t be compared using the comparison operators.</div><div class="line"></div><div class="line">The most generic solution is to use the DeepEqual() function in the reflect package.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;reflect&quot;</div><div class="line">)</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    num int                //ok</div><div class="line">    checks [10]func() bool //not comparable</div><div class="line">    doit func() bool       //not comparable</div><div class="line">    m map[string] string   //not comparable</div><div class="line">    bytes []byte           //not comparable</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    v1 := data{}<br>    v2 := data{}<br>    fmt.Println(“v1 == v2:”,reflect.DeepEqual(v1,v2)) //prints: v1 == v2: true</p>
<pre><code>m1 := map[string]string{&quot;one&quot;: &quot;a&quot;,&quot;two&quot;: &quot;b&quot;}
m2 := map[string]string{&quot;two&quot;: &quot;b&quot;, &quot;one&quot;: &quot;a&quot;}
fmt.Println(&quot;m1 == m2:&quot;,reflect.DeepEqual(m1, m2)) //prints: m1 == m2: true

s1 := []int{1, 2, 3}
s2 := []int{1, 2, 3}
fmt.Println(&quot;s1 == s2:&quot;,reflect.DeepEqual(s1, s2)) //prints: s1 == s2: true
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Aside from being slow (which may or may not be a deal breaker for your application), DeepEqual() also has its own gotchas.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;reflect&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    var b1 []byte = nil</div><div class="line">    b2 := []byte&#123;&#125;</div><div class="line">    fmt.Println(&quot;b1 == b2:&quot;,reflect.DeepEqual(b1, b2)) //prints: b1 == b2: false</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DeepEqual() doesn’t consider an empty slice to be equal to a “nil” slice. This behavior is different from the behavior you get using the bytes.Equal() function. bytes.Equal() considers “nil” and empty slices to be equal.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"bytes"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> b1 []<span class="keyword">byte</span> = <span class="literal">nil</span></div><div class="line">    b2 := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">    fmt.Println(<span class="string">"b1 == b2:"</span>,bytes.Equal(b1, b2)) <span class="comment">//prints: b1 == b2: true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DeepEqual() isn’t always perfect comparing slices.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"reflect"</span></div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> str <span class="keyword">string</span> = <span class="string">"one"</span></div><div class="line">    <span class="keyword">var</span> in <span class="keyword">interface</span>&#123;&#125; = <span class="string">"one"</span></div><div class="line">    fmt.Println(<span class="string">"str == in:"</span>,str == in,reflect.DeepEqual(str, in))</div><div class="line">    <span class="comment">//prints: str == in: true true</span></div><div class="line"></div><div class="line">    v1 := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>&#125;</div><div class="line">    v2 := []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">"one"</span>,<span class="string">"two"</span>&#125;</div><div class="line">    fmt.Println(<span class="string">"v1 == v2:"</span>,reflect.DeepEqual(v1, v2))</div><div class="line">    <span class="comment">//prints: v1 == v2: false (not ok)</span></div><div class="line"></div><div class="line">    data := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</div><div class="line">        <span class="string">"code"</span>: <span class="number">200</span>,</div><div class="line">        <span class="string">"value"</span>: []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>&#125;,</div><div class="line">    &#125;</div><div class="line">    encoded, _ := json.Marshal(data)</div><div class="line">    <span class="keyword">var</span> decoded <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">    json.Unmarshal(encoded, &amp;decoded)</div><div class="line">    fmt.Println(<span class="string">"data == decoded:"</span>,reflect.DeepEqual(data, decoded))</div><div class="line">    <span class="comment">//prints: data == decoded: false (not ok)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If your byte slices (or strings) contain text data you might be tempted to use  ToUpper() or ToLower() from the “bytes” and “strings” packages when you need to compare values in a case insensitive manner (before using  ==,bytes.Equal(), or bytes.Compare()). It will work for English text, but it will not work for text in many other languages. strings.EqualFold() and  bytes.EqualFold() should be used instead.</p>
<p>If your byte slices contain secrets (e.g., cryptographic hashes, tokens, etc.) that need to be validated against user-provided data, don’t use reflect.DeepEqual(),  bytes.Equal(), or bytes.Compare() because those functions will make your application vulnerable to timing attacks. To avoid leaking the timing information use the functions from the ‘crypto/subtle’ package (e.g.,  subtle.ConstantTimeCompare()).</p>
<p>Recovering From a Panic</p>
<p>level: intermediate<br>The recover() function can be used to catch/intercept a panic. Calling  recover() will do the trick only when it’s done in a deferred function.</p>
<p>Incorrect:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="built_in">recover</span>() <span class="comment">//doesn't do anything</span></div><div class="line">    <span class="built_in">panic</span>(<span class="string">"not good"</span>)</div><div class="line">    <span class="built_in">recover</span>() <span class="comment">//won't be executed :)</span></div><div class="line">    fmt.Println(<span class="string">"ok"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        fmt.Println(<span class="string">"recovered:"</span>,<span class="built_in">recover</span>())</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="built_in">panic</span>(<span class="string">"not good"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>The call to recover() works only if it’s called directly in your deferred function.</p>
<blockquote>
<p>Fails:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doRecover</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"recovered =&gt;"</span>,<span class="built_in">recover</span>()) <span class="comment">//prints: recovered =&gt; &lt;nil&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>func main() {<br>    defer func() {<br>        doRecover() //panic is not recovered<br>    }()</p>
<pre><code>panic(&quot;not good&quot;)
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Updating and Referencing Item Values in Slice, Array, and Map &quot;range&quot; Clauses</div><div class="line"></div><div class="line">level: intermediate</div><div class="line">The data values generated in the &quot;range&quot; clause are copies of the actual collection elements. They are not references to the original items. This means that updating the values will not change the original data. It also means that taking the address of the values will not give you pointers to the original data.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    data := []int&#123;1,2,3&#125;</div><div class="line">    for _,v := range data &#123;</div><div class="line">        v *= 10 //original item is not changed</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(&quot;data:&quot;,data) //prints data: [1 2 3]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>If you need to update the original collection record value use the index operator to access the data.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    <span class="keyword">for</span> i,_ := <span class="keyword">range</span> data &#123;</div><div class="line">        data[i] *= <span class="number">10</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"data:"</span>,data) <span class="comment">//prints data: [10 20 30]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If your collection holds pointer values then the rules are slightly different. You still need to use the index operator if you want the original record to point to another value, but you can update the data stored at the target location using the second value in the “for range” clause.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []*<span class="keyword">struct</span>&#123;num <span class="keyword">int</span>&#125; &#123;&#123;<span class="number">1</span>&#125;,&#123;<span class="number">2</span>&#125;,&#123;<span class="number">3</span>&#125;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        v.num *= <span class="number">10</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(data[<span class="number">0</span>],data[<span class="number">1</span>],data[<span class="number">2</span>]) <span class="comment">//prints &amp;&#123;10&#125; &amp;&#123;20&#125; &amp;&#123;30&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>“Hidden” Data in Slices</p>
<p>level: intermediate<br>When you reslice a slice, the new slice will reference the array of the original slice. If you forget about this behavior it can lead to unexpected memory usage if your application allocates large temporary slices creating new slices from them to refer to small sections of the original data.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;</div><div class="line">    raw := <span class="built_in">make</span>([]<span class="keyword">byte</span>,<span class="number">10000</span>)</div><div class="line">    fmt.Println(<span class="built_in">len</span>(raw),<span class="built_in">cap</span>(raw),&amp;raw[<span class="number">0</span>]) <span class="comment">//prints: 10000 10000 &lt;byte_addr_x&gt;</span></div><div class="line">    <span class="keyword">return</span> raw[:<span class="number">3</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func main() {<br>    data := get()<br>    fmt.Println(len(data),cap(data),&amp;data[0]) //prints: 3 10000 <byte_addr_x><br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">To avoid this trap make sure to copy the data you need from the temporary slice (instead of reslicing it).</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func get() []byte &#123;</div><div class="line">    raw := make([]byte,10000)</div><div class="line">    fmt.Println(len(raw),cap(raw),&amp;raw[0]) //prints: 10000 10000 &lt;byte_addr_x&gt;</div><div class="line">    res := make([]byte,3)</div><div class="line">    copy(res,raw[:3])</div><div class="line">    return res</div><div class="line">&#125;</div></pre></td></tr></table></figure></byte_addr_x></p>
<p>func main() {<br>    data := get()<br>    fmt.Println(len(data),cap(data),&amp;data[0]) //prints: 3 3 <byte_addr_y><br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Slice Data &quot;Corruption&quot;</div><div class="line"></div><div class="line">level: intermediate</div><div class="line">Let&apos;s say you need to rewrite a path (stored in a slice). You reslice the path to reference each directory modifying the first folder name and then you combine the names to create a new path.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;fmt&quot;</div><div class="line">    &quot;bytes&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    path := []byte(&quot;AAAA/BBBBBBBBB&quot;)</div><div class="line">    sepIndex := bytes.IndexByte(path,&apos;/&apos;)</div><div class="line">    dir1 := path[:sepIndex]</div><div class="line">    dir2 := path[sepIndex+1:]</div><div class="line">    fmt.Println(&quot;dir1 =&gt;&quot;,string(dir1)) //prints: dir1 =&gt; AAAA</div><div class="line">    fmt.Println(&quot;dir2 =&gt;&quot;,string(dir2)) //prints: dir2 =&gt; BBBBBBBBB</div><div class="line"></div><div class="line">    dir1 = append(dir1,&quot;suffix&quot;...)</div><div class="line">    path = bytes.Join([][]byte&#123;dir1,dir2&#125;,[]byte&#123;&apos;/&apos;&#125;)</div><div class="line"></div><div class="line">    fmt.Println(&quot;dir1 =&gt;&quot;,string(dir1)) //prints: dir1 =&gt; AAAAsuffix</div><div class="line">    fmt.Println(&quot;dir2 =&gt;&quot;,string(dir2)) //prints: dir2 =&gt; uffixBBBB (not ok)</div><div class="line"></div><div class="line">    fmt.Println(&quot;new path =&gt;&quot;,string(path))</div><div class="line">&#125;</div></pre></td></tr></table></figure></byte_addr_y></p>
<p>It didn’t work as you expected. Instead of “AAAAsuffix/BBBBBBBBB” you ended up with “AAAAsuffix/uffixBBBB”. It happened because both directory slices referenced the same underlying array data from the original path slice. This means that the original path is also modified. Depending on your application this might be a problem too.</p>
<p>This problem can fixed by allocating new slices and copying the data you need. Another option is to use the full slice expression.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"bytes"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    path := []<span class="keyword">byte</span>(<span class="string">"AAAA/BBBBBBBBB"</span>)</div><div class="line">    sepIndex := bytes.IndexByte(path,<span class="string">'/'</span>)</div><div class="line">    dir1 := path[:sepIndex:sepIndex] <span class="comment">//full slice expression</span></div><div class="line">    dir2 := path[sepIndex+<span class="number">1</span>:]</div><div class="line">    fmt.Println(<span class="string">"dir1 =&gt;"</span>,<span class="keyword">string</span>(dir1)) <span class="comment">//prints: dir1 =&gt; AAAA</span></div><div class="line">    fmt.Println(<span class="string">"dir2 =&gt;"</span>,<span class="keyword">string</span>(dir2)) <span class="comment">//prints: dir2 =&gt; BBBBBBBBB</span></div><div class="line"></div><div class="line">    dir1 = <span class="built_in">append</span>(dir1,<span class="string">"suffix"</span>...)</div><div class="line">    path = bytes.Join([][]<span class="keyword">byte</span>&#123;dir1,dir2&#125;,[]<span class="keyword">byte</span>&#123;<span class="string">'/'</span>&#125;)</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"dir1 =&gt;"</span>,<span class="keyword">string</span>(dir1)) <span class="comment">//prints: dir1 =&gt; AAAAsuffix</span></div><div class="line">    fmt.Println(<span class="string">"dir2 =&gt;"</span>,<span class="keyword">string</span>(dir2)) <span class="comment">//prints: dir2 =&gt; BBBBBBBBB (ok now)</span></div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"new path =&gt;"</span>,<span class="keyword">string</span>(path))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The extra parameter in the full slice expression controls the capacity for the new slice. Now appending to that slice will trigger a new buffer allocation instead of overwriting the data in the second slice.</p>
<p>“Stale” Slices</p>
<p>level: intermediate<br>Multiple slices can reference the same data. This can happen when you create a new slice from an existing slice, for example. If your application relies on this behavior to function properly then you’ll need to worry about “stale” slices.</p>
<p>At some point adding data to one of the slices will result in a new array allocation when the original array can’t hold any more new data. Now other slices will point to the old array (with old data).</p>
<p>import “fmt”</p>
<p>func main() {<br>    s1 := []int{1,2,3}<br>    fmt.Println(len(s1),cap(s1),s1) //prints 3 3 [1 2 3]</p>
<pre><code>s2 := s1[1:]
fmt.Println(len(s2),cap(s2),s2) //prints 2 2 [2 3]

for i := range s2 { s2[i] += 20 }

//still referencing the same array
fmt.Println(s1) //prints [1 22 23]
fmt.Println(s2) //prints [22 23]

s2 = append(s2,4)

for i := range s2 { s2[i] += 10 }

//s1 is now &quot;stale&quot;
fmt.Println(s1) //prints [1 22 23]
fmt.Println(s2) //prints [32 33 14]
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Type Declarations and Methods</div><div class="line"></div><div class="line">level: intermediate</div><div class="line">When you create a type declaration by defining a new type from an existing (non-interface) type, you don&apos;t inherit the methods defined for that existing type.</div><div class="line"></div><div class="line">&gt; Fails:</div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;sync&quot;</div><div class="line"></div><div class="line">type myMutex sync.Mutex</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    var mtx myMutex</div><div class="line">    mtx.Lock() //error</div><div class="line">    mtx.Unlock() //error</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Compile Errors:</p>
</blockquote>
<p>/tmp/sandbox106401185/main.go:9: mtx.Lock undefined (type myMutex has no field or method Lock) /tmp/sandbox106401185/main.go:10: mtx.Unlock undefined (type myMutex has no field or method Unlock)</p>
<p>If you do need the methods from the original type you can define a new struct type embedding the original type as an anonymous field.</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> myLocker <span class="keyword">struct</span> &#123;</div><div class="line">    sync.Mutex</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>func main() {<br>    var lock myLocker<br>    lock.Lock() //ok<br>    lock.Unlock() //ok<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Interface type declarations also retain their method sets.</div><div class="line"></div><div class="line">&gt; Works:</div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;sync&quot;</div><div class="line"></div><div class="line">type myLocker sync.Locker</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    var lock myLocker = new(sync.Mutex)</div><div class="line">    lock.Lock() //ok</div><div class="line">    lock.Unlock() //ok</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Breaking Out of “for switch” and “for select” Code Blocks</p>
<p>level: intermediate<br>A “break” statement without a label only gets you out of the inner switch/select block. If using a “return” statement is not an option then defining a label for the outer loop is the next best thing.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    loop:</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">switch</span> &#123;</div><div class="line">            <span class="keyword">case</span> <span class="literal">true</span>:</div><div class="line">                fmt.Println(<span class="string">"breaking out..."</span>)</div><div class="line">                <span class="keyword">break</span> loop</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"out!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>A “goto” statement will do the trick too…</p>
<p>Iteration Variables and Closures in “for” Statements</p>
<p>level: intermediate<br>This is the most common gotcha in Go. The iteration variables in for statements are reused in each iteration. This means that each closure (aka function literal) created in your for loop will reference the same variable (and they’ll get that variable’s value at the time those goroutines start executing).</p>
<p>Incorrect:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: three, three, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The easiest solution (that doesn’t require any changes to the goroutine) is to save the current iteration variable value in a local variable inside the for loop block.</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        vcopy := v <span class="comment">//</span></div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Println(vcopy)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: one, two, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Another solution is to pass the current iteration variable as a parameter to the anonymous goroutine.</p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(in <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">            fmt.Println(in)</div><div class="line">        &#125;(v)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: one, two, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Here’s a slightly more complicated version of the trap.</p>
<p>Incorrect:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> field <span class="keyword">struct</span> &#123;</div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func (p *field) print() {<br>    fmt.Println(p.name)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    data := []field&#123;&#123;&quot;one&quot;&#125;,&#123;&quot;two&quot;&#125;,&#123;&quot;three&quot;&#125;&#125;</div><div class="line"></div><div class="line">    for _,v := range data &#123;</div><div class="line">        go v.print()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(3 * time.Second)</div><div class="line">    //goroutines print: three, three, three</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> field <span class="keyword">struct</span> &#123;</div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>func (p *field) print() {<br>    fmt.Println(p.name)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    data := []field&#123;&#123;&quot;one&quot;&#125;,&#123;&quot;two&quot;&#125;,&#123;&quot;three&quot;&#125;&#125;</div><div class="line"></div><div class="line">    for _,v := range data &#123;</div><div class="line">        v := v</div><div class="line">        go v.print()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(3 * time.Second)</div><div class="line">    //goroutines print: one, two, three</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>What do you think you’ll see when you run this code (and why)?</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> field <span class="keyword">struct</span> &#123;</div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func (p *field) print() {<br>    fmt.Println(p.name)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    data := []*field&#123;&#123;&quot;one&quot;&#125;,&#123;&quot;two&quot;&#125;,&#123;&quot;three&quot;&#125;&#125;</div><div class="line"></div><div class="line">    for _,v := range data &#123;</div><div class="line">        go v.print()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(3 * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Deferred Function Call Argument Evaluation</p>
<p>level: intermediate<br>Arguments for a deferred function call are evaluated when the defer statement is evaluated (not when the function is actually executing).</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"result =&gt;"</span>,<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> i * <span class="number">2</span> &#125;())</div><div class="line">    i++</div><div class="line">    <span class="comment">//prints: result =&gt; 2 (not ok if you expected 4)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Deferred Function Call Execution</p>
<p>level: intermediate<br>The deferred calls are executed at the end of the containing function and not at the end of the containing code block. It’s an easy mistake to make for new Go developers confusing the deferred code execution rules with the variable scoping rules. It can become a problem if you have a long running function with a for loop that tries to defer resource cleanup calls in each iteration.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"path/filepath"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> &#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    start, err := os.Stat(os.Args[<span class="number">1</span>])</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !start.IsDir()&#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> targets []<span class="keyword">string</span></div><div class="line">    filepath.Walk(os.Args[<span class="number">1</span>], <span class="function"><span class="keyword">func</span><span class="params">(fpath <span class="keyword">string</span>, fi os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> !fi.Mode().IsRegular() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        targets = <span class="built_in">append</span>(targets,fpath)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,target := <span class="keyword">range</span> targets &#123;</div><div class="line">        f, err := os.Open(target)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(<span class="string">"bad target:"</span>,target,<span class="string">"error:"</span>,err) <span class="comment">//prints error: too many open files</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">defer</span> f.Close() <span class="comment">//will not be closed at the end of this code block</span></div><div class="line">        <span class="comment">//do something with the file...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>One way to solve the problem is by wrapping the code block in a function.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"path/filepath"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> &#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    start, err := os.Stat(os.Args[<span class="number">1</span>])</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !start.IsDir()&#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> targets []<span class="keyword">string</span></div><div class="line">    filepath.Walk(os.Args[<span class="number">1</span>], <span class="function"><span class="keyword">func</span><span class="params">(fpath <span class="keyword">string</span>, fi os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> !fi.Mode().IsRegular() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        targets = <span class="built_in">append</span>(targets,fpath)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,target := <span class="keyword">range</span> targets &#123;</div><div class="line">        <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            f, err := os.Open(target)</div><div class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                fmt.Println(<span class="string">"bad target:"</span>,target,<span class="string">"error:"</span>,err)</div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">defer</span> f.Close() <span class="comment">//ok</span></div><div class="line">            <span class="comment">//do something with the file...</span></div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Another option is to get rid of the defer statement :-)</p>
<p>Failed Type Assertions</p>
<p>level: intermediate<br>Failed type assertions return the “zero value” for the target type used in the assertion statement. This can lead to unexpected behavior when it’s mixed with variable shadowing.</p>
<p>Incorrect:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> data <span class="keyword">interface</span>&#123;&#125; = <span class="string">"great"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> data, ok := data.(<span class="keyword">int</span>); ok &#123;</div><div class="line">        fmt.Println(<span class="string">"[is an int] value =&gt;"</span>,data)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"[not an int] value =&gt;"</span>,data)</div><div class="line">        <span class="comment">//prints: [not an int] value =&gt; 0 (not "great")</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> data <span class="keyword">interface</span>&#123;&#125; = <span class="string">"great"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> res, ok := data.(<span class="keyword">int</span>); ok &#123;</div><div class="line">        fmt.Println(<span class="string">"[is an int] value =&gt;"</span>,res)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"[not an int] value =&gt;"</span>,data)</div><div class="line">        <span class="comment">//prints: [not an int] value =&gt; great (as expected)</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Blocked Goroutines and Resource Leaks</p>
<p>level: intermediate<br>Rob Pike talked about a number of fundamental concurrency patterns in his “Go Concurrency Patterns” presentation at Google I/O in 2012. Fetching the first result from a number of targets is one of them.</p>
<p>func First(query string, replicas …Search) Result {<br>    c := make(chan Result)<br>    searchReplica := func(i int) { c &lt;- replicas<a href="query">i</a> }<br>    for i := range replicas {<br>        go searchReplica(i)<br>    }<br>    return &lt;-c<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">The function starts a goroutines for each search replica. Each goroutine sends its search result to the result channel. The first value from the result channel is returned.</div><div class="line"></div><div class="line">What about the results from the other goroutines? What about the goroutines themselves?</div><div class="line"></div><div class="line">The result channel in the First() function is unbuffered. This means that only the first goroutine returns. All other goroutines are stuck trying to send their results. This means if you have more than one replica each call will leak resources.</div><div class="line"></div><div class="line">To avoid the leaks you need to make sure all goroutines exit. One potential solution is to use a buffered result channel big enough to hold all results.</div><div class="line"></div><div class="line">func First(query string, replicas ...Search) Result &#123;</div><div class="line">    c := make(chan Result,len(replicas))</div><div class="line">    searchReplica := func(i int) &#123; c &lt;- replicas[i](query) &#125;</div><div class="line">    for i := range replicas &#123;</div><div class="line">        go searchReplica(i)</div><div class="line">    &#125;</div><div class="line">    return &lt;-c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Another potential solution is to use a select statement with a default case and a buffered result channel that can hold one value. The default case ensures that the goroutines don’t get stuck even when the result channel can’t receive messages.</p>
<p>func First(query string, replicas …Search) Result {<br>    c := make(chan Result,1)<br>    searchReplica := func(i int) {<br>        select {<br>        case c &lt;- replicas<a href="query">i</a>:<br>        default:<br>        }<br>    }<br>    for i := range replicas {<br>        go searchReplica(i)<br>    }<br>    return &lt;-c<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">You can also use a special cancellation channel to interrupt the workers.</div><div class="line"></div><div class="line">func First(query string, replicas ...Search) Result &#123;</div><div class="line">    c := make(chan Result)</div><div class="line">    done := make(chan struct&#123;&#125;)</div><div class="line">    defer close(done)</div><div class="line">    searchReplica := func(i int) &#123;</div><div class="line">        select &#123;</div><div class="line">        case c &lt;- replicas[i](query):</div><div class="line">        case &lt;- done:</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    for i := range replicas &#123;</div><div class="line">        go searchReplica(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return &lt;-c</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Why did the presentation contain these bugs? Rob Pike simply didn’t want to comlicate the slides. It makes sense, but it can be a problem for new Go developers who would use the code as is without thinking that it might have problems.</p>
<p>Using Pointer Receiver Methods On Value Instances</p>
<p>level: advanced<br>It’s OK to call a pointer receiver method on a value as long as the value is addressable. In other words, you don’t need to have a value receiver version of the method in some cases.</p>
<p>Not every variable is addressable though. Map elements are not addressable. Variables referenced through interfaces are also not addressable.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;</div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func (p *data) print() {<br>    fmt.Println(“name:”,p.name)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">type printer interface &#123;</div><div class="line">    print()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    d1 := data{“one”}<br>    d1.print() //ok</p>
<pre><code>var in printer = data{&quot;two&quot;} //error
in.print()

m := map[string]data {&quot;x&quot;:data{&quot;three&quot;}}
m[&quot;x&quot;].print() //error
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&gt; Compile Errors:</div><div class="line"></div><div class="line">/tmp/sandbox017696142/main.go:21: cannot use data literal (type data) as type printer in assignment: data does not implement printer (print method has pointer receiver)</div><div class="line">/tmp/sandbox017696142/main.go:25: cannot call pointer method on m[&quot;x&quot;] /tmp/sandbox017696142/main.go:25: cannot take the address of m[&quot;x&quot;]</div><div class="line"></div><div class="line">Updating Map Value Fields</div><div class="line"></div><div class="line">level: advanced</div><div class="line">If you have a map of struct values you can&apos;t update individual struct fields.</div><div class="line"></div><div class="line">&gt; Fails:</div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    name string</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    m := map[string]data {“x”:{“one”}}<br>    m[“x”].name = “two” //error<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&gt; Compile Error:</div><div class="line"></div><div class="line">/tmp/sandbox380452744/main.go:9: cannot assign to m[&quot;x&quot;].name</div><div class="line"></div><div class="line">It doesn&apos;t work because map elements are not addressable.</div><div class="line"></div><div class="line">What can be extra confusing for new Go devs is the fact that slice elements are addressable.</div><div class="line"></div><div class="line">```gopackage main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    name string</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    s := []data one<br>    s[0].name = “two” //ok<br>    fmt.Println(s)    //prints: [{two}]<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Note that a while ago it was possible to update map element fields in one of the Go compilers (gccgo), but that behavior was quickly fixed :-) It was also considered as a potential feature for Go 1.3. It wasn&apos;t important enough to support at that point in time, so it&apos;s still on the todo list.</div><div class="line"></div><div class="line">The first work around is to use a temporary variable.</div><div class="line"></div><div class="line">```gopackage main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    name string</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    m := map[string]data {“x”:{“one”}}<br>    r := m[“x”]<br>    r.name = “two”<br>    m[“x”] = r<br>    fmt.Printf(“%v”,m) //prints: map[x:{two}]<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Another workaround is to use a map of pointers.</div><div class="line"></div><div class="line">```gopackage main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    name string</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    m := map[string]*data {“x”:{“one”}}<br>    m[“x”].name = “two” //ok<br>    fmt.Println(m[“x”]) //prints: &amp;{two}<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">By the way, what happens when you run this code?</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">type data struct &#123;</div><div class="line">    name string</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    m := map[string]*data {“x”:{“one”}}<br>    m[“z”].name = “what?” //???<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&quot;nil&quot; Interfaces and &quot;nil&quot; Interfaces Values</div><div class="line"></div><div class="line">level: advanced</div><div class="line">This is the second most common gotcha in Go because interfaces are not pointers even though they may look like pointers. Interface variables will be &quot;nil&quot; only when their type and value fields are &quot;nil&quot;.</div><div class="line"></div><div class="line">The interface type and value fields are populated based on the type and value of the variable used to create the corresponding interface variable. This can lead to unexpected behavior when you are trying to check if an interface variable equals to &quot;nil&quot;.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    var data *byte</div><div class="line">    var in interface&#123;&#125;</div><div class="line"></div><div class="line">    fmt.Println(data,data == nil) //prints: &lt;nil&gt; true</div><div class="line">    fmt.Println(in,in == nil)     //prints: &lt;nil&gt; true</div><div class="line"></div><div class="line">    in = data</div><div class="line">    fmt.Println(in,in == nil)     //prints: &lt;nil&gt; false</div><div class="line">    //&apos;data&apos; is &apos;nil&apos;, but &apos;in&apos; is not &apos;nil&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Watch out for this trap when you have a function that returns interfaces.</p>
<p>Incorrect:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    doit := <span class="function"><span class="keyword">func</span><span class="params">(arg <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">        <span class="keyword">var</span> result *<span class="keyword">struct</span>&#123;&#125; = <span class="literal">nil</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span>(arg &gt; <span class="number">0</span>) &#123;</div><div class="line">            result = &amp;<span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> res := doit(<span class="number">-1</span>); res != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"good result:"</span>,res) <span class="comment">//prints: good result: &lt;nil&gt;</span></div><div class="line">        <span class="comment">//'res' is not 'nil', but its value is 'nil'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Works:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    doit := <span class="function"><span class="keyword">func</span><span class="params">(arg <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">        <span class="keyword">var</span> result *<span class="keyword">struct</span>&#123;&#125; = <span class="literal">nil</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span>(arg &gt; <span class="number">0</span>) &#123;</div><div class="line">            result = &amp;<span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">//return an explicit 'nil'</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> res := doit(<span class="number">-1</span>); res != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"good result:"</span>,res)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"bad result (res is nil)"</span>) <span class="comment">//here as expected</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Stack and Heap Variables</p>
<p>level: advanced<br>You don’t always know if your variable is allocated on the stack or heap. In C++ creating variables using the new operator always means that you have a heap variable. In Go the compiler decides where the variable will be allocated even if the new() or make() functions are used. The compiler picks the location to store the variable based on its size and the result of “escape analysis”. This also means that it’s ok to return references to local variables, which is not ok in other languages like C or C++.</p>
<p>If you need to know where your variables are allocated pass the “-m” gc flag to “go build” or “go run” (e.g., go run -gcflags -m app.go).</p>
<p>GOMAXPROCS, Concurrency, and Parallelism</p>
<p>level: advanced<br>Go 1.4 and below uses only one execution context / OS thread. This means that only one goroutine can execute at any given time. Starting with 1.5 Go sets the number of execution contexts to the number of logical CPU cores returned by  runtime.NumCPU(). That number may or may not match the total number of logical CPU cores on your system depending on the CPU affinity settings of your process. You can adjust this number by changing the GOMAXPROCS environment variable or by calling the runtime.GOMAXPROCS() function.</p>
<p>There’s a common misconception that GOMAXPROCS represents the number of CPUs Go will use to run goroutines. The runtime.GOMAXPROCS() function documentation adds more to the confusion. The GOMAXPROCS variable description (<a href="https://golang.org/pkg/runtime/" target="_blank" rel="external">https://golang.org/pkg/runtime/</a>) does a better job talking about OS threads.</p>
<p>You can set GOMAXPROCS to more than the number of your CPUs. The max value for GOMAXPROCS is 256.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">-1</span>)) <span class="comment">//prints: X (1 on play.golang.org)</span></div><div class="line">    fmt.Println(runtime.NumCPU())       <span class="comment">//prints: X (1 on play.golang.org)</span></div><div class="line">    runtime.GOMAXPROCS(<span class="number">20</span>)</div><div class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">-1</span>)) <span class="comment">//prints: 20</span></div><div class="line">    runtime.GOMAXPROCS(<span class="number">300</span>)</div><div class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">-1</span>)) <span class="comment">//prints: 256</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Read and Write Operation Reordering</p>
<p>level: advanced<br>Go may reorder some operations, but it ensures that the overall behavior in the goroutine where it happens doesn’t change. However, it doesn’t guarantee the order of execution across multiple goroutines.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"runtime"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> _ = runtime.GOMAXPROCS(<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> a, b <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">u1</span><span class="params">()</span></span> &#123;</div><div class="line">    a = <span class="number">1</span></div><div class="line">    b = <span class="number">2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>func u2() {<br>    a = 3<br>    b = 4<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">func p() &#123;</div><div class="line">    println(a)</div><div class="line">    println(b)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>func main() {<br>    go u1()<br>    go u2()<br>    go p()<br>    time.Sleep(1 * time.Second)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">If you run this code a few times you might see these a and b variable combinations:</div><div class="line"></div><div class="line">1</div><div class="line">2</div><div class="line"></div><div class="line">3</div><div class="line">4</div><div class="line"></div><div class="line">0</div><div class="line">2</div><div class="line"></div><div class="line">0</div><div class="line">0</div><div class="line"></div><div class="line">1</div><div class="line">4</div><div class="line"></div><div class="line">The most interesting combination for a and b is &quot;02&quot;. It shows that b was updated before a.</div><div class="line"></div><div class="line">If you need to preserve the order of read and write operations across multiple goroutines you&apos;ll need to use channels or the appropriate constructs from the &quot;sync&quot; package.</div><div class="line"></div><div class="line">Preemptive Scheduling</div><div class="line"></div><div class="line">level: advanced</div><div class="line">It&apos;s possible to have a rogue goroutine that prevents other goroutines from running. It can happen if you have a for loop that doesn&apos;t allow the scheduler to run.</div><div class="line"></div><div class="line">```go</div><div class="line">package main</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    done := false</div><div class="line"></div><div class="line">    go func()&#123;</div><div class="line">        done = true</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    for !done &#123;</div><div class="line">    &#125;</div><div class="line">    fmt.Println(&quot;done!&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>The for loop doesn’t have to be empty. It’ll be a problem as long as it contains code that doesn’t trigger the scheduler execution.</p>
<p>The scheduler will run after GC, “go” statements, blocking channel operations, blocking system calls, and lock operations. It may also run when a non-inlined function is called.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    done := <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        done = <span class="literal">true</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> !done &#123;</div><div class="line">        fmt.Println(<span class="string">"not done!"</span>) <span class="comment">//not inlined</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"done!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>To find out if the function you call in the for loop is inlined pass the “-m” gc flag to “go build” or “go run” (e.g., go build -gcflags -m).</p>
<p>Another option is to invoke the scheduler explicitly. You can do it with the  Gosched() function from the “runtime” package.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    done := <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        done = <span class="literal">true</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> !done &#123;</div><div class="line">        runtime.Gosched()</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"done!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/14/enough-with-the-microservices/" rel="prev" title="Enough with the microservices">
                Enough with the microservices <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>


    <div class="post-spread">
      
        
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "1",
        "bdMiniList": false,
        "bdPic": ""
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      },
      "slide": {
        "bdImg": "5",
        "bdPos": "left",
        "bdTop": "100"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/7314785"
               alt="武鑫" />
          <p class="site-author-name" itemprop="name">武鑫</p>
           
              <p class="site-description motion-element" itemprop="description">人行中正，剑走偏锋；<br/>目游长远，足履飞星。</p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/sin5th" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#total-beginner"><span class="nav-number">1.</span> <span class="nav-text">Total Beginner</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#opening-brace-cant-be-placed-on-a-separate-line"><span class="nav-number">1.1.</span> <span class="nav-text">Opening Brace Can’t Be Placed on a Separate Line</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unused-variables"><span class="nav-number">1.2.</span> <span class="nav-text">Unused Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unused-imports"><span class="nav-number">1.3.</span> <span class="nav-text">Unused Imports</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#short-variable-declarations-can-be-used-only-inside-functions"><span class="nav-number">1.4.</span> <span class="nav-text">Short Variable Declarations Can Be Used Only Inside Functions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redeclaring-variables-using-short-variable-declarations"><span class="nav-number">1.5.</span> <span class="nav-text">Redeclaring Variables Using Short Variable Declarations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cant-use-short-variable-declarations-to-set-field-values"><span class="nav-number">1.6.</span> <span class="nav-text">Can’t Use Short Variable Declarations to Set Field Values</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cant-use-nil-to-initialize-a-variable-without-an-explicit-type"><span class="nav-number">1.7.</span> <span class="nav-text">Can’t Use “nil” to Initialize a Variable Without an Explicit Type</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#strings-cant-be-nil"><span class="nav-number">1.8.</span> <span class="nav-text">Strings Can’t Be “nil”</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">武鑫</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
















  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blog-sin5th-com.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://blog.sin5th.com/2017/06/27/50-shades-of-go/';
          this.page.identifier = '2017/06/27/50-shades-of-go/';
          this.page.title = 'Go 语言的 50 个陷阱';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://blog-sin5th-com.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.0"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.0"></script>


  

</body>
</html>
